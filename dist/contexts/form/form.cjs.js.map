{"version":3,"file":"form.cjs.js","sources":["../../../src/contexts/form/form.tsx"],"sourcesContent":["// Dependencies\nimport * as React from 'react';\nimport { payments } from '@square/web-sdk';\nimport type * as Square from '@square/web-sdk';\n\n// Internals\nimport { ErrorScreen } from '~/components/error-screen';\nimport { useDynamicCallback } from '~/hooks/use-dynamic-callback';\nimport type { FormContextType, FormProviderProps } from './form.types';\n\n/**\n * Internal helper that the `PaymentForm` uses to manage internal state and\n * expose access to the Web Payment SDK library.\n */\nconst FormContext = React.createContext<FormContextType>({\n  cardTokenizeResponseReceived: null as unknown as () => Promise<void>,\n  createPaymentRequest: null as unknown as Square.PaymentRequestOptions,\n  payments: null as unknown as Square.Payments,\n});\n\nfunction FormProvider({ applicationId, locationId, children, overrides, ...props }: FormProviderProps) {\n  const [instance, setInstance] = React.useState<Square.Payments>();\n  const [createPaymentRequest] = React.useState<undefined | Square.PaymentRequestOptions>(() =>\n    props.createPaymentRequest?.()\n  );\n\n  React.useEffect(() => {\n    const abortController = new AbortController();\n    const { signal } = abortController;\n\n    async function loadPayment(signal?: AbortSignal): Promise<void> {\n      await payments(applicationId, locationId, overrides).then((res) => {\n        if (res === null) {\n          throw new Error('Square Web Payments SDK failed to load');\n        }\n\n        if (signal?.aborted) {\n          return;\n        }\n\n        setInstance(res);\n\n        return res;\n      });\n    }\n\n    if (applicationId && locationId) {\n      loadPayment(signal);\n    }\n\n    return () => {\n      abortController.abort();\n    };\n  }, [applicationId, locationId]);\n\n  const cardTokenizeResponseReceived = async (rest: Square.TokenResult): Promise<void> => {\n    if (rest.errors || !props.createVerificationDetails) {\n      await props.cardTokenizeResponseReceived(rest);\n      return;\n    }\n\n    const verifyBuyerResults = await instance?.verifyBuyer(String(rest.token), props.createVerificationDetails());\n\n    await props.cardTokenizeResponseReceived(rest, verifyBuyerResults);\n  };\n\n  // Fixes stale closure issue with using React Hooks & SqPaymentForm callback functions\n  // https://github.com/facebook/react/issues/16956\n  const cardTokenizeResponseReceivedCallback = useDynamicCallback(cardTokenizeResponseReceived);\n\n  if (!applicationId || !locationId) {\n    return <ErrorScreen />;\n  }\n\n  if (!instance) return null;\n\n  const context: FormContextType = {\n    cardTokenizeResponseReceived: cardTokenizeResponseReceivedCallback,\n    createPaymentRequest,\n    payments: instance,\n  };\n\n  return <FormContext.Provider value={context}>{children}</FormContext.Provider>;\n}\n\nconst useForm = (): FormContextType => {\n  const context = React.useContext(FormContext);\n\n  if (context === undefined) {\n    throw new Error('useForm must be used within a FormProvider');\n  }\n\n  return context;\n};\n\nexport { FormContext, useForm };\nexport default FormProvider;\n"],"names":["FormContext","React","FormProvider","applicationId","locationId","children","overrides","props","instance","setInstance","createPaymentRequest","abortController","signal","loadPayment","payments","res","cardTokenizeResponseReceived","rest","verifyBuyerResults","cardTokenizeResponseReceivedCallback","useDynamicCallback","ErrorScreen","context","useForm"],"mappings":"inBAcMA,EAAcC,EAAM,cAA+B,CACvD,6BAA8B,KAC9B,qBAAsB,KACtB,SAAU,IACZ,CAAC,EAED,SAASC,EAAa,CAAE,cAAAC,EAAe,WAAAC,EAAY,SAAAC,EAAU,UAAAC,KAAcC,GAA4B,CACrG,KAAM,CAACC,EAAUC,CAAW,EAAIR,EAAM,SAA0B,EAC1D,CAACS,CAAoB,EAAIT,EAAM,SAAmD,IACtFM,EAAM,uBAAuB,CAAA,EAG/BN,EAAM,UAAU,IAAM,CACd,MAAAU,EAAkB,IAAI,gBACtB,CAAE,OAAAC,CAAW,EAAAD,EAEnB,eAAeE,EAAYD,EAAqC,CAC9D,MAAME,EAAAA,SAASX,EAAeC,EAAYE,CAAS,EAAE,KAAMS,GAAQ,CACjE,GAAIA,IAAQ,KACJ,MAAA,IAAI,MAAM,wCAAwC,EAG1D,GAAIH,CAAAA,GAAQ,QAIZ,OAAAH,EAAYM,CAAG,EAERA,CAAA,CACR,CACH,CAEA,OAAIZ,GAAiBC,GACnBS,EAAYD,CAAM,EAGb,IAAM,CACXD,EAAgB,MAAM,CAAA,CACxB,EACC,CAACR,EAAeC,CAAU,CAAC,EAExB,MAAAY,EAA+B,MAAOC,GAA4C,CACtF,GAAIA,EAAK,QAAU,CAACV,EAAM,0BAA2B,CAC7C,MAAAA,EAAM,6BAA6BU,CAAI,EAC7C,MACF,CAEM,MAAAC,EAAqB,MAAMV,GAAU,YAAY,OAAOS,EAAK,KAAK,EAAGV,EAAM,0BAAA,CAA2B,EAEtG,MAAAA,EAAM,6BAA6BU,EAAMC,CAAkB,CAAA,EAK7DC,EAAuCC,qBAAmBJ,CAA4B,EAExF,GAAA,CAACb,GAAiB,CAACC,EACrB,uBAAQiB,EAAY,QAAA,IAAA,EAGtB,GAAI,CAACb,EAAiB,OAAA,KAEtB,MAAMc,EAA2B,CAC/B,6BAA8BH,EAC9B,qBAAAT,EACA,SAAUF,CAAA,EAGZ,uBAAQR,EAAY,SAAZ,CAAqB,MAAOsB,GAAUjB,CAAS,CACzD,CAEA,MAAMkB,EAAU,IAAuB,CAC/B,MAAAD,EAAUrB,EAAM,WAAWD,CAAW,EAE5C,GAAIsB,IAAY,OACR,MAAA,IAAI,MAAM,4CAA4C,EAGvD,OAAAA,CACT"}